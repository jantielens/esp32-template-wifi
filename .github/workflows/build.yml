name: ESP32 Build

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Generate build matrix from config.sh
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      project_name: ${{ steps.set-matrix.outputs.project_name }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate board matrix from config.sh
      id: set-matrix
      run: |
        # Source config.sh and extract FQBN_TARGETS and PROJECT_NAME
        source config.sh
        
        # Export PROJECT_NAME for artifact naming
        echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        
        # Build JSON array for matrix
        boards_json="["
        first=true
        for fqbn in "${!FQBN_TARGETS[@]}"; do
          board_name=$(get_board_name "$fqbn")
          if [ "$first" = true ]; then
            first=false
          else
            boards_json+=","
          fi
          boards_json+="{\"name\":\"$board_name\",\"fqbn\":\"$fqbn\"}"
        done
        boards_json+="]"
        
        echo "matrix={\"board\":$boards_json}" >> $GITHUB_OUTPUT
        echo "Generated matrix: {\"board\":$boards_json}"

  build:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Cache arduino-cli
      uses: actions/cache@v4
      with:
        path: |
          bin/arduino-cli
          ~/.arduino15
        key: ${{ runner.os }}-arduino-cli-${{ hashFiles('setup.sh', 'arduino-libraries.txt') }}
        restore-keys: |
          ${{ runner.os }}-arduino-cli-
    
    - name: Install arduino-cli and ESP32 platform
      run: |
        chmod +x setup.sh
        ./setup.sh
    
    - name: Compile firmware for ${{ matrix.board.name }}
      run: |
        chmod +x build.sh
        ./build.sh ${{ matrix.board.name }}
    
    - name: Check for build artifacts
      run: |
        BOARD_DIR="build/${{ matrix.board.name }}"
        if [ ! -d "$BOARD_DIR" ] || [ -z "$(ls -A "$BOARD_DIR"/*.bin 2>/dev/null)" ]; then
          echo "Error: Firmware binary not found for ${{ matrix.board.name }}"
          exit 1
        fi
        echo "Build successful for ${{ matrix.board.name }}!"
        ls -lh "$BOARD_DIR"/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ needs.prepare-matrix.outputs.project_name }}-${{ matrix.board.name }}
        path: |
          build/${{ matrix.board.name }}/*.bin
          build/${{ matrix.board.name }}/*.elf
        retention-days: 30
    
    - name: Generate build summary
      run: |
        echo "## Build Summary - ${{ matrix.board.name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Board:** ${{ matrix.board.name }}" >> $GITHUB_STEP_SUMMARY
        echo "**FQBN:** ${{ matrix.board.fqbn }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Firmware Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        for file in build/${{ matrix.board.name }}/*.bin; do
          if [ -f "$file" ]; then
            size=$(ls -lh "$file" | awk '{print $5}')
            name=$(basename "$file")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          fi
        done
