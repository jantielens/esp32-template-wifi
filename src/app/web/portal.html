<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PROJECT_DISPLAY_NAME}} Configuration Portal</title>
    <link rel="stylesheet" href="/portal.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>{{PROJECT_DISPLAY_NAME}} Configuration</h1>
            <div class="version-badges">
                <span id="firmware-version" class="version-badge">Firmware v0.0.0</span>
                <span id="chip-info" class="version-badge">Loading...</span>
                <span id="cpu-cores" class="version-badge">Loading...</span>
                <span id="cpu-freq" class="version-badge">Loading...</span>
                <span id="flash-size" class="version-badge">Loading...</span>
                <span id="psram-status" class="version-badge">Loading...</span>
            </div>
        </header>

        <div id="status-message" class="message" style="display:none;"></div>

        <div id="form-loading-overlay" class="form-loading-overlay">
            <div class="spinner" style="width: 50px; height: 50px;"></div>
            <p style="margin-top: 15px; color: #667eea; font-weight: 600;">Loading configuration...</p>
        </div>

        <form id="config-form">
            <!-- Core Settings Section (always visible) -->
            <section class="section core-section">
                <h2>üì∂ WiFi Settings</h2>
                <div class="form-group">
                    <label for="wifi_ssid">WiFi SSID</label>
                    <input type="text" id="wifi_ssid" name="wifi_ssid" maxlength="31" required>
                    <small>Network name (max 31 characters)</small>
                </div>
                <div class="form-group">
                    <label for="wifi_password">WiFi Password</label>
                    <input type="password" id="wifi_password" name="wifi_password" maxlength="63">
                    <small>Leave empty if network is open</small>
                </div>
            </section>

            <section class="section core-section">
                <h2>üîß Device Settings</h2>
                <div class="form-group">
                    <label for="device_name">Device Name</label>
                    <input type="text" id="device_name" name="device_name" maxlength="31" required>
                    <small>Can include spaces and special characters</small>
                </div>
                <div class="form-group">
                    <label>mDNS Name</label>
                    <div id="device_name_sanitized" class="mdns-label">esp32-xxxx.local</div>
                    <small>Auto-generated from device name for network discovery</small>
                </div>
            </section>

            <section class="section core-section">
                <h2>üåê Network Configuration (Optional)</h2>
                <div class="form-group">
                    <label for="fixed_ip">Fixed IP Address</label>
                    <input type="text" id="fixed_ip" name="fixed_ip" maxlength="15" placeholder="e.g. 192.168.1.100">
                    <small>Leave empty for DHCP</small>
                </div>
                <div class="form-group">
                    <label for="subnet_mask">Subnet Mask</label>
                    <input type="text" id="subnet_mask" name="subnet_mask" maxlength="15" placeholder="e.g. 255.255.255.0">
                    <small>Required if fixed IP is set</small>
                </div>
                <div class="form-group">
                    <label for="gateway">Gateway</label>
                    <input type="text" id="gateway" name="gateway" maxlength="15" placeholder="e.g. 192.168.1.1">
                    <small>Required if fixed IP is set</small>
                </div>
                <div class="form-group">
                    <label for="dns1">DNS Server 1</label>
                    <input type="text" id="dns1" name="dns1" maxlength="15" placeholder="Defaults to gateway">
                    <small>Optional - defaults to gateway if not provided</small>
                </div>
                <div class="form-group">
                    <label for="dns2">DNS Server 2</label>
                    <input type="text" id="dns2" name="dns2" maxlength="15" placeholder="Optional">
                    <small>Optional - leave empty if not needed</small>
                </div>
            </section>

            <!-- Additional Settings Section (hidden in core mode) -->
            <section class="section full-section" id="additional-settings" style="display:none;">
                <h2>‚öôÔ∏è Additional Settings</h2>
                <div class="form-group">
                    <label for="dummy_setting">Dummy Setting</label>
                    <input type="text" id="dummy_setting" name="dummy_setting" maxlength="63">
                    <small>Example setting for demonstration</small>
                </div>
            </section>

            <section class="section">
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save and Reboot</button>
                    <button type="button" id="reboot-btn" class="btn btn-secondary">Reboot (without saving)</button>
                    <button type="button" id="reset-btn" class="btn btn-danger">Factory Reset</button>
                </div>
            </section>
        </form>

        <section class="section">
            <h2>üîß Advanced</h2>
            <div class="button-group">
                <a href="/logs" class="btn btn-secondary" style="text-decoration: none; display: inline-block; text-align: center;">üìã View Device Logs</a>
            </div>
        </section>

        <section class="section ota-section">
            <h2>üì¶ Firmware Update (OTA)</h2>
            <div class="form-group">
                <label for="firmware-file">Upload Firmware (.bin)</label>
                <input type="file" id="firmware-file" accept=".bin" class="file-input">
                <small>Upload app.ino.bin from build directory</small>
            </div>
            <button type="button" id="upload-btn" class="btn btn-warning" disabled>Upload Firmware</button>
        </section>

        <footer>
            <p id="build-info" class="small">Loading build info...</p>
        </footer>
    </div>

    <!-- Floating Health Widget -->
    <div id="health-widget" class="health-widget">
        <div class="health-widget-compact" id="health-compact">
            <div class="health-status-dot" id="health-status-dot"></div>
            <span id="health-cpu" class="health-metric">CPU --</span>
            <span class="health-expand-icon">‚ãÆ</span>
        </div>
        <div class="health-widget-expanded" id="health-expanded" style="display:none;">
            <div class="health-header">
                <div class="health-status-dot" id="health-status-dot-expanded"></div>
                <span>Device Health</span>
                <button id="health-close" class="health-close-btn">‚úï</button>
            </div>
            <div class="health-stats">
                <!-- System -->
                <div class="health-stat">
                    <span class="health-label">Uptime</span>
                    <span class="health-value" id="health-uptime">--</span>
                </div>
                <div class="health-stat">
                    <span class="health-label">Reset Reason</span>
                    <span class="health-value" id="health-reset">--</span>
                </div>
                <!-- CPU -->
                <div class="health-stat">
                    <span class="health-label">CPU Usage</span>
                    <span class="health-value" id="health-cpu-full">--</span>
                </div>
                <div class="health-stat">
                    <span class="health-label">Core Temp</span>
                    <span class="health-value" id="health-temp">--</span>
                </div>
                <!-- Memory -->
                <div class="health-stat">
                    <span class="health-label">Free Heap</span>
                    <span class="health-value" id="health-heap">--</span>
                </div>
                <div class="health-stat">
                    <span class="health-label">Min Free Heap</span>
                    <span class="health-value" id="health-heap-min">--</span>
                </div>
                <div class="health-stat">
                    <span class="health-label">Heap Fragmentation</span>
                    <span class="health-value" id="health-heap-frag">--</span>
                </div>
                <!-- Storage -->
                <div class="health-stat">
                    <span class="health-label">Flash Usage</span>
                    <span class="health-value" id="health-flash">--</span>
                </div>
                <!-- Network -->
                <div class="health-stat">
                    <span class="health-label">WiFi RSSI</span>
                    <span class="health-value" id="health-rssi">--</span>
                </div>
                <div class="health-stat">
                    <span class="health-label">IP Address</span>
                    <span class="health-value" id="health-ip">--</span>
                </div>
            </div>
        </div>
    </div>

    <div id="captive-portal-warning" class="reboot-overlay" style="display:none;">
        <div class="reboot-modal">
            <h2>Reconnection Required</h2>
            <p>After saving, this captive portal window will close when the device reboots.</p>
            <p style="margin: 20px 0;">To access the device again, open your browser and go to:</p>
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #667eea;">
                <code id="device-mdns-address" style="font-size: 18px; color: #667eea; font-weight: 600;">http://device.local</code>
            </div>
            <p class="small" style="color: #666; margin-bottom: 20px;">Tip: Save this address or bookmark it for easy access</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                <button id="continue-save-btn" class="btn btn-primary" style="width: auto; min-width: 150px;">Continue and Save</button>
                <button id="cancel-save-btn" class="btn" style="width: auto; min-width: 100px;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="reboot-overlay" class="reboot-overlay" style="display:none;">
        <div class="reboot-modal">
            <div id="reboot-spinner" class="spinner"></div>
            <h2 id="reboot-title">Device Rebooting</h2>
            <p id="reboot-message">Please wait while the device restarts...</p>
            <div id="reboot-progress-container" style="margin: 25px 0; display: none;">
                <div class="progress-bar" style="height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                    <div id="reboot-progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                </div>
                <div id="reboot-progress-text" style="margin-top: 10px; font-size: 18px; font-weight: 600; color: #667eea;">0%</div>
            </div>
            <p id="reboot-submessage" class="small">This page will automatically refresh when ready</p>
            <div id="reconnect-status" class="reconnect-status"></div>
        </div>
    </div>

    <script src="/portal.js"></script>
</body>
</html>
